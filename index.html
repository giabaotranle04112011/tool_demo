<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ğŸ² AI Probability Analyzer â€“ Gemini 2.5 VIP Pro 2026</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --bg: #0b0f1a;
    --card: #131a2f;
    --accent: #1e293b;
    --text: #e2e8f0;
    --text-muted: #94a3b8;
    --green: #22c55e;
    --red: #ef4444;
    --orange: #f59e0b;
    --purple: #a78bfa;
    --blue: #3b82f6;
    --yellow: #facc15;
    --light-green: #86efac;
    --light-red: #f87171;
  }
  body {
    font-family: system-ui, -apple-system, sans-serif;
    background: linear-gradient(135deg, #0b0f1a 0%, #1e1b4b 100%);
    color: var(--text);
    margin: 0;
    padding: 16px;
    min-height: 100vh;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }
  h1 {
    font-size: 22px;
    text-align: center;
    margin-bottom: 8px;
    font-weight: 700;
    background: linear-gradient(90deg, #a78bfa, #60a5fa, #22c55e);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  h1 + small {
    display: block;
    text-align: center;
    color: var(--text-muted);
    font-size: 16px;
    margin-bottom: 24px;
  }
  .card {
    background: var(--card);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.4);
    border: 1px solid #2a3448;
    position: relative;
    overflow: hidden;
  }
  .row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
  }
  .btn {
    padding: 18px;
    border-radius: 12px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s;
    flex: 1;
    min-height: 60px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    user-select: none;
  }
  .btn:active { transform: scale(0.96); }
  .dark { background: var(--accent); color: var(--text); }
  .red { background: var(--red); color: #fff; }
  .green { background: var(--green); color: #fff; }
  .orange { background: var(--orange); color: #fff; }
  .purple { background: var(--purple); color: #fff; }
  .blue { background: var(--blue); color: #fff; }
  .yellow { background: var(--yellow); color: #000; }
  .reset { background: #475569; color: #fff; }
  .speak { background: linear-gradient(45deg, #22c55e, #16a34a); color: #fff; animation: pulse 2s infinite; }
  .undo { background: #ef4444; color: #fff; }
  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
    50% { box-shadow: 0 0 0 12px rgba(34, 197, 94, 0); }
  }
  input, #quick3 {
    width: 100%;
    padding: 16px;
    border-radius: 12px;
    border: none;
    margin-top: 8px;
    font-size: 16px;
    background: var(--accent);
    color: var(--text);
    box-sizing: border-box;
  }
  input::placeholder, #quick3::placeholder { color: var(--text-muted); }
  small { color: var(--text-muted); font-size: 14px; display: block; margin-top: 8px; }
  .guide {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid #3b82f6;
    padding: 16px;
    border-radius: 12px;
    margin-top: 12px;
    font-size: 15px;
    line-height: 1.8;
    display: none;
  }
  #hist {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 16px;
    max-height: 240px;
    overflow-y: auto;
    padding: 10px;
    background: rgba(30, 41, 59, 0.3);
    border-radius: 12px;
  }
  #hist span {
    border-radius: 12px;
    padding: 12px 16px;
    font-size: 15px;
    font-weight: 500;
    min-width: 120px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    position: relative;
  }
  #hist span::after {
    content: attr(data-index);
    position: absolute;
    top: 4px; left: 8px;
    font-size: 11px;
    opacity: 0.6;
  }
  #streakInfo {
    margin-top: 16px;
    font-weight: 600;
    text-align: center;
    color: var(--yellow);
    font-size: 18px;
    display: none;
  }
  #out {
    white-space: pre-wrap;
    line-height: 1.8;
    font-size: 16px;
    min-height: 160px;
    background: var(--accent);
    padding: 18px;
    border-radius: 12px;
    margin-top: 12px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
  }
  #out.speaking {
    border-color: var(--green);
    box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
    background: rgba(34, 197, 94, 0.08);
  }
  #voiceControls {
    display: flex;
    gap: 10px;
    margin-top: 16px;
    flex-wrap: wrap;
  }
  .voice-btn {
    padding: 14px;
    border-radius: 10px;
    border: none;
    font-size: 15px;
    cursor: pointer;
    font-weight: 500;
    flex: 1;
    min-height: 52px;
  }
  #chartContainer {
    margin-top: 20px;
    background: var(--accent);
    border-radius: 12px;
    padding: 12px;
    height: 360px;
    display: none;
  }
  canvas { max-height: 100% !important; width: 100% !important; }
  .hidden { display: none !important; }
  @media (max-width: 600px) {
    .row { flex-direction: column; }
    #voiceControls { flex-direction: column; }
  }
</style>
</head>
<body>
<h1>ğŸ² AI Probability Analyzer</h1>
<small>Gemini 2.5 VIP Pro 2026 â€“ Miá»…n phÃ­ Gemini 2.5 Flash + Second-Order Markov ğŸ“ˆğŸ™ï¸ğŸ”¥</small>

<div class="card">
  <div style="font-weight:600;margin-bottom:8px">ğŸ”‘ API Key Google Gemini (MIá»„N PHÃ)</div>
  <input id="key" placeholder="AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX">
  <small>Láº¥y key miá»…n phÃ­ táº¡i: <a href="https://aistudio.google.com/app/api-keys" target="_blank" style="color:#60a5fa">aistudio.google.com/app/api-keys</a><br>CÃ³ key â†’ phÃ¢n tÃ­ch Gemini 2.5 Flash siÃªu chi tiáº¿t + Ä‘á»c to. Key lÆ°u tá»± Ä‘á»™ng.</small>
</div>

<div class="card" id="vipSection">
  <div style="font-weight:600;margin-bottom:8px">â­ Má»Ÿ khÃ³a VIP (Second-order Markov + giá»ng nÃ³i nÃ¢ng cao)</div>
  <input id="vipKey" placeholder="Nháº­p key (admin123)">
  <button class="btn yellow" onclick="unlockVIP()" style="margin-top:12px">ğŸ”“ Má»Ÿ khÃ³a VIP</button>
</div>

<div class="card">
  <div style="font-weight:600;margin-bottom:12px">â• Nháº­p káº¿t quáº£ tá»«ng vÃ¡n</div>
  <div class="row">
    <button class="btn dark" onclick="add('Long báº£o xanh')">Long báº£o xanh<br><small>Player tháº¯ng</small></button>
    <button class="btn dark" onclick="add('Long báº£o Ä‘á»')">Long báº£o Ä‘á»<br><small>Banker tháº¯ng</small></button>
    <button class="btn green" onclick="add('ÄÃ´i xanh')">ÄÃ´i xanh<br><small>Player Ä‘Ã´i</small></button>
    <button class="btn red" onclick="add('ÄÃ´i Ä‘á»')">ÄÃ´i Ä‘á»<br><small>Banker Ä‘Ã´i</small></button>
    <button class="btn orange" onclick="add('HÃ²a')">HÃ²a</button>
  </div>

  <div style="margin-top:28px">
    <div style="font-weight:600;margin-bottom:8px">âš¡ Nháº­p nhanh nhiá»u vÃ¡n</div>
    <div class="row" style="align-items:flex-start">
      <input id="quick3" placeholder="VÃ­ dá»¥: Long báº£o Ä‘á», ÄÃ´i xanh, HÃ²a">
      <button class="btn purple" onclick="addQuick3()">â• ThÃªm táº¥t cáº£</button>
    </div>
    <small>DÃ¹ng dáº¥u pháº©y Ä‘á»ƒ phÃ¢n cÃ¡ch cÃ¡c vÃ¡n.</small>
    <button class="btn blue" onclick="toggleGuide()" style="margin-top:16px">ğŸ“– Danh sÃ¡ch tÃªn cá»­a chuáº©n</button>
    <div id="guide" class="guide">
      <b>TÃªn chuáº©n (copy Ä‘Ãºng):</b><br><br>
      â€¢ Long báº£o xanh<br>â€¢ Long báº£o Ä‘á»<br>â€¢ ÄÃ´i xanh<br>â€¢ ÄÃ´i Ä‘á»<br>â€¢ HÃ²a
    </div>
  </div>

  <div id="hist" class="hidden"></div>
  <div id="streakInfo"></div>
  <div id="histEmpty" style="text-align:center;color:var(--text-muted);padding:20px">ChÆ°a cÃ³ dá»¯ liá»‡u...</div>
</div>

<div class="card">
  <div class="row">
    <button id="analyzeBtn" class="btn green speak" style="flex:2;font-size:18px;position:relative" onclick="analyze()">
      ğŸ”® PhÃ¢n tÃ­ch Gemini 2.5 AI + Äá»c to ğŸ™ï¸
    </button>
    <button class="btn reset" onclick="resetAll()">ğŸ—‘ï¸ Reset</button>
    <button class="btn undo" onclick="undoLast()">â†©ï¸ Undo</button>
  </div>
  <div class="row" style="margin-top:12px">
    <button class="btn blue" onclick="copyHistory()">ğŸ“‹ Copy Lá»‹ch Sá»­</button>
    <button class="btn orange" onclick="exportHistory()">ğŸ“¤ Export</button>
    <button class="btn purple" onclick="importHistory()">ğŸ“¥ Import</button>
  </div>
</div>

<div class="card">
  <div style="font-weight:600;margin-bottom:8px">ğŸ“Š Káº¿t quáº£ phÃ¢n tÃ­ch <span id="status"></span></div>
  <div id="out">ğŸ‘† Nháº­p Ã­t nháº¥t 5-10 vÃ¡n rá»“i báº¥m nÃºt xanh Ä‘á»ƒ xem phÃ¢n tÃ­ch chi tiáº¿t!</div>

  <div style="margin-top:12px;text-align:center">
    <button class="btn blue" onclick="copyAnalysis()">ğŸ“‹ Copy káº¿t quáº£ phÃ¢n tÃ­ch</button>
  </div>

  <div id="chartContainer">
    <canvas id="statsChart"></canvas>
  </div>

  <div id="voiceControls" class="hidden">
    <button class="voice-btn" style="background:#ef4444" onclick="stopSpeech()">â¹ï¸ Dá»«ng</button>
    <button class="voice-btn" style="background:#f59e0b" onclick="toggleSpeech()">â¸ï¸ Táº¡m dá»«ng / Tiáº¿p</button>
    <select class="voice-btn" id="voiceSpeed" onchange="changeSpeed()" style="background:var(--purple)">
      <option value="0.8">ğŸŒ Cháº­m</option>
      <option value="1.0" selected>ğŸš¶ BÃ¬nh thÆ°á»ng</option>
      <option value="1.2">ğŸ† Nhanh</option>
      <option value="1.5">âš¡ SiÃªu nhanh</option>
    </select>
    <select class="voice-btn" id="voiceSelect" onchange="changeVoice()" style="background:var(--blue);flex:2"></select>
  </div>

  <div id="vipMarkov" class="hidden" style="margin-top:20px;padding:16px;background:rgba(167,139,250,0.15);border-radius:12px;border:1px solid var(--purple);font-size:15px;line-height:1.8">
    â­ <strong>VIP Dá»± Ä‘oÃ¡n Markov (Second-order):</strong><br><span id="markovText">Äang tÃ­nh toÃ¡n...</span>
  </div>
</div>

<script>
let hist = [];
let synth = window.speechSynthesis;
let currentUtterance = null;
let isPaused = false;
let currentSpeed = 1.0;
let selectedVoice = null;
let isVIP = localStorage.getItem('isVIP') === 'true';
let chart = null;
let ttsReady = false;

const outcomes = ['Long báº£o xanh', 'Long báº£o Ä‘á»', 'ÄÃ´i xanh', 'ÄÃ´i Ä‘á»', 'HÃ²a'];

function enableTTS() {
  if (ttsReady) return;
  const utter = new SpeechSynthesisUtterance("");
  synth.speak(utter);
  synth.cancel();
  ttsReady = true;
}

function loadVoices() {
  let voices = synth.getVoices();
  if (!voices.length) { setTimeout(loadVoices, 300); return; }

  const voiceSelect = document.getElementById('voiceSelect');
  voiceSelect.innerHTML = '';

  let viVoices = voices.filter(v => v.lang.includes('vi'));
  let preferred = viVoices.length ? viVoices : voices.filter(v => v.lang.includes('en'));

  preferred.forEach(voice => {
    let opt = document.createElement('option');
    opt.value = voice.name;
    opt.textContent = `${voice.name} (${voice.lang})`;
    voiceSelect.appendChild(opt);
  });

  if (preferred.length) {
    selectedVoice = preferred[0];
    voiceSelect.value = selectedVoice.name;
  }

  if (isVIP || hist.length > 0) document.getElementById('voiceControls').classList.remove('hidden');
}

function speak(text, auto = true) {
  if (!ttsReady) enableTTS();
  stopSpeech();

  currentUtterance = new SpeechSynthesisUtterance(text);
  if (selectedVoice) currentUtterance.voice = selectedVoice;
  currentUtterance.lang = 'vi-VN';
  currentUtterance.rate = currentSpeed;
  currentUtterance.pitch = 1.05;
  currentUtterance.volume = 1;

  currentUtterance.onstart = () => {
    document.getElementById('out').classList.add('speaking');
    document.getElementById('status').textContent = 'ğŸ™ï¸ Äang Ä‘á»c...';
    document.getElementById('voiceControls').classList.remove('hidden');
  };
  currentUtterance.onend = currentUtterance.onerror = () => {
    document.getElementById('out').classList.remove('speaking');
    document.getElementById('status').textContent = '';
  };

  synth.speak(currentUtterance);
}

function stopSpeech() {
  synth.cancel();
  isPaused = false;
  currentUtterance = null;
  document.getElementById('out').classList.remove('speaking');
  document.getElementById('status').textContent = '';
}

function toggleSpeech() {
  if (!currentUtterance) return;
  if (isPaused) {
    synth.resume();
    isPaused = false;
  } else {
    synth.pause();
    isPaused = true;
  }
}

function changeSpeed() {
  currentSpeed = parseFloat(document.getElementById('voiceSpeed').value);
  if (currentUtterance) currentUtterance.rate = currentSpeed;
}

function changeVoice() {
  const name = document.getElementById('voiceSelect').value;
  selectedVoice = synth.getVoices().find(v => v.name === name) || null;
}

function copyAnalysis() {
  const text = document.getElementById('out').textContent;
  navigator.clipboard.writeText(text).then(() => {
    alert('âœ… ÄÃ£ copy káº¿t quáº£ phÃ¢n tÃ­ch vÃ o clipboard!');
  }).catch(() => {
    alert('âŒ Copy tháº¥t báº¡i, hÃ£y chá»n vÃ  copy thá»§ cÃ´ng.');
  });
}

function copyHistory() {
  if (hist.length === 0) return alert('ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘á»ƒ copy!');
  const text = hist.join(' â†’ ');
  navigator.clipboard.writeText(text).then(() => {
    alert('âœ… ÄÃ£ copy lá»‹ch sá»­ dáº¡ng Ä‘áº¹p (â†’) vÃ o clipboard!');
  });
}

function exportHistory() {
  if (hist.length === 0) return alert('ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘á»ƒ export!');
  const text = hist.join(', ');
  navigator.clipboard.writeText(text).then(() => {
    alert('âœ… ÄÃ£ copy lá»‹ch sá»­ (dáº¡ng pháº©y) Ä‘á»ƒ import sau!');
  }).catch(() => {
    prompt('Copy thá»§ cÃ´ng:', text);
  });
}

function importHistory() {
  const input = prompt('Paste lá»‹ch sá»­ (cÃ¡c vÃ¡n cÃ¡ch nhau báº±ng dáº¥u pháº©y):');
  if (!input) return;
  const vals = input.split(',').map(s => s.trim());
  const valid = vals.filter(s => outcomes.includes(s));
  if (valid.length === 0) return alert('KhÃ´ng tÃ¬m tháº¥y vÃ¡n há»£p lá»‡ nÃ o!');
  const msg = `TÃ¬m tháº¥y ${valid.length} vÃ¡n há»£p lá»‡.\nThay tháº¿ lá»‹ch sá»­ hiá»‡n táº¡i (${hist.length} vÃ¡n)?`;
  if (confirm(msg)) {
    hist = valid;
    saveHistory();
    render();
    document.getElementById('out').textContent = 'ÄÃ£ import lá»‹ch sá»­ má»›i! Báº¥m PhÃ¢n tÃ­ch Ä‘á»ƒ xem káº¿t quáº£.';
    if (chart) { chart.destroy(); chart = null; }
    document.getElementById('chartContainer').style.display = 'none';
  }
}

function add(v) {
  if (!outcomes.includes(v)) return alert("TÃªn cá»­a khÃ´ng há»£p lá»‡!");
  hist.push(v);
  saveHistory();
  render();
  if (ttsReady) speak(`${v} Ä‘Ã£ thÃªm.`, false);
}

function addQuick3() {
  const input = document.getElementById("quick3").value.trim();
  if (!input) return alert("ChÆ°a nháº­p dá»¯ liá»‡u!");
  const vals = input.split(",").map(s => s.trim()).filter(s => outcomes.includes(s));
  if (vals.length === 0) return alert("KhÃ´ng cÃ³ cá»­a há»£p lá»‡ nÃ o!");
  hist.push(...vals);
  document.getElementById("quick3").value = "";
  saveHistory();
  render();
  if (ttsReady) speak(`ÄÃ£ thÃªm ${vals.length} vÃ¡n.`, false);
}

function undoLast() {
  if (hist.length === 0) return alert("KhÃ´ng cÃ³ gÃ¬ Ä‘á»ƒ undo!");
  const removed = hist.pop();
  saveHistory();
  render();
  if (ttsReady) speak(`ÄÃ£ xÃ³a vÃ¡n cuá»‘i: ${removed}`, false);
}

function render() {
  const h = document.getElementById("hist");
  const empty = document.getElementById("histEmpty");
  const streakInfo = document.getElementById("streakInfo");

  if (hist.length === 0) {
    h.classList.add('hidden');
    empty.style.display = 'block';
    streakInfo.style.display = 'none';
    return;
  }
  empty.style.display = 'none';
  h.classList.remove('hidden');
  h.innerHTML = "";

  hist.forEach((v, i) => {
    const s = document.createElement("span");
    s.textContent = v;
    s.setAttribute('data-index', i + 1);

    let bgColor = '#1e293b';
    let textColor = '#e2e8f0';

    if (v === 'Long báº£o xanh') { bgColor = '#22c55e'; textColor = '#fff'; }
    else if (v === 'Long báº£o Ä‘á»') { bgColor = '#ef4444'; textColor = '#fff'; }
    else if (v === 'ÄÃ´i xanh') { bgColor = '#86efac'; textColor = '#000'; }
    else if (v === 'ÄÃ´i Ä‘á»') { bgColor = '#f87171'; textColor = '#000'; }
    else if (v === 'HÃ²a') { bgColor = '#facc15'; textColor = '#000'; }

    s.style.backgroundColor = bgColor;
    s.style.color = textColor;

    h.appendChild(s);
  });

  const stats = getStats();
  if (stats.total > 0) {
    streakInfo.textContent = `ğŸ”¥ Streak hiá»‡n táº¡i: ${stats.currentStreak} vÃ¡n liÃªn tiáº¿p ${stats.streakType}`;
    streakInfo.style.display = 'block';
  } else {
    streakInfo.style.display = 'none';
  }
}

function saveHistory() {
  localStorage.setItem('gameHistory', JSON.stringify(hist));
}

function loadHistory() {
  const saved = localStorage.getItem('gameHistory');
  if (saved) hist = JSON.parse(saved);
  render();
}

function getStats() {
  const cnt = {
    'Long báº£o xanh': 0,
    'Long báº£o Ä‘á»': 0,
    'ÄÃ´i xanh': 0,
    'ÄÃ´i Ä‘á»': 0,
    'HÃ²a': 0
  };
  hist.forEach(v => cnt[v]++);
  const total = hist.length;
  const playerWin = cnt['Long báº£o xanh'] + cnt['ÄÃ´i xanh'];
  const bankerWin = cnt['Long báº£o Ä‘á»'] + cnt['ÄÃ´i Ä‘á»'];
  const tie = cnt['HÃ²a'];

  let currentStreak = 1;
  let streakType = hist[hist.length-1] || '';
  for (let i = hist.length-2; i >= 0; i--) {
    if (hist[i] === streakType) currentStreak++;
    else break;
  }

  let maxStreak = 1;
  if (total > 1) {
    let current = 1;
    for (let i = 1; i < total; i++) {
      if (hist[i] === hist[i-1]) {
        current++;
        maxStreak = Math.max(maxStreak, current);
      } else {
        current = 1;
      }
    }
  }

  return { cnt, total, playerWin, bankerWin, tie, currentStreak, streakType, maxStreak };
}

function markovPrediction() {
  if (hist.length < 3) return "âš ï¸ Cáº§n Ã­t nháº¥t 3 vÃ¡n Ä‘á»ƒ dá»± Ä‘oÃ¡n Markov.";
  let text = "ğŸ”® Dá»± Ä‘oÃ¡n cá»­a tiáº¿p theo (Second-order Markov - VIP Pro):\n";
  let predictions = [];
  let usedSecond = false;

  if (hist.length >= 6) {
    const transitions = {};
    for (let i = 0; i < hist.length - 2; i++) {
      const key = hist[i] + '|' + hist[i+1];
      const to = hist[i+2];
      if (!transitions[key]) transitions[key] = {};
      transitions[key][to] = (transitions[key][to] || 0) + 1;
    }
    const lastKey = hist[hist.length-2] + '|' + hist[hist.length-1];
    const nextCounts = transitions[lastKey] || {};
    const totalNext = Object.values(nextCounts).reduce((a,b) => a + b, 0);
    if (totalNext > 0) {
      usedSecond = true;
      outcomes.forEach(o => {
        const prob = nextCounts[o] ? (nextCounts[o] / totalNext * 100).toFixed(1) : 0;
        if (prob > 0) predictions.push({outcome: o, prob});
      });
      predictions.sort((a,b) => b.prob - a.prob);
    }
  }

  if (!usedSecond) {
    text = "ğŸ”® Dá»± Ä‘oÃ¡n cá»­a tiáº¿p theo (First-order Markov - fallback):\n";
    const transitions = {};
    for (let i = 0; i < hist.length - 1; i++) {
      const from = hist[i];
      const to = hist[i+1];
      if (!transitions[from]) transitions[from] = {};
      transitions[from][to] = (transitions[from][to] || 0) + 1;
    }
    const last = hist[hist.length-1];
    const nextCounts = transitions[last] || {};
    const totalNext = Object.values(nextCounts).reduce((a,b) => a + b, 0);
    if (totalNext === 0) return "âš ï¸ ChÆ°a Ä‘á»§ dá»¯ liá»‡u chuyá»ƒn tiáº¿p.";
    outcomes.forEach(o => {
      const prob = nextCounts[o] ? (nextCounts[o] / totalNext * 100).toFixed(1) : 0;
      if (prob > 0) predictions.push({outcome: o, prob: parseFloat(prob)});
    });
    predictions.sort((a,b) => b.prob - a.prob);
  }

  if (predictions.length === 0) return "âš ï¸ ChÆ°a Ä‘á»§ dá»¯ liá»‡u.";
  predictions.forEach(p => text += `â€¢ ${p.outcome}: ${p.prob}%\n`);
  text += `\nğŸ’¡ Gá»£i Ã½ máº¡nh nháº¥t: ${predictions[0].outcome} (${predictions[0].prob}%)`;
  if (usedSecond) text += "\n(Äá»™ chÃ­nh xÃ¡c cao â€“ dá»±a trÃªn 2 vÃ¡n gáº§n nháº¥t)";
  return text;
}

function drawChart(stats) {
  const ctx = document.getElementById('statsChart').getContext('2d');
  if (chart) chart.destroy();

  const labels = Object.keys(stats.cnt);
  const data = Object.values(stats.cnt);

  const type = stats.total < 100 ? 'doughnut' : 'bar';

  chart = new Chart(ctx, {
    type: type,
    data: {
      labels: labels,
      datasets: [{
        label: 'Sá»‘ láº§n xuáº¥t hiá»‡n',
        data: data,
        backgroundColor: ['#22c55e', '#ef4444', '#86efac', '#f87171', '#facc15'],
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { color: '#e2e8f0', font: { size: 14 } } },
        title: { display: true, text: 'PhÃ¢n bá»‘ káº¿t quáº£', color: '#e2e8f0', font: { size: 16 } }
      },
      scales: type === 'bar' ? {
        y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: '#2a3448' } },
        x: { ticks: { color: '#94a3b8' }, grid: { color: '#2a3448' } }
      } : {}
    }
  });

  document.getElementById('chartContainer').style.display = 'block';
}

async function analyze() {
  if (hist.length === 0) return alert("ChÆ°a cÃ³ dá»¯ liá»‡u!");

  const stats = getStats();
  const { cnt, total, playerWin, bankerWin, tie, currentStreak, streakType, maxStreak } = stats;

  let basicText = `ğŸ“Š Tá»•ng: ${total} vÃ¡n\n\n`;
  basicText += `â€¢ Long báº£o xanh: ${cnt['Long báº£o xanh']} (${((cnt['Long báº£o xanh']/total)*100).toFixed(1)}%)\n`;
  basicText += `â€¢ Long báº£o Ä‘á»: ${cnt['Long báº£o Ä‘á»']} (${((cnt['Long báº£o Ä‘á»']/total)*100).toFixed(1)}%)\n`;
  basicText += `â€¢ ÄÃ´i xanh: ${cnt['ÄÃ´i xanh']} (${((cnt['ÄÃ´i xanh']/total)*100).toFixed(1)}%)\n`;
  basicText += `â€¢ ÄÃ´i Ä‘á»: ${cnt['ÄÃ´i Ä‘á»']} (${((cnt['ÄÃ´i Ä‘á»']/total)*100).toFixed(1)}%)\n`;
  basicText += `â€¢ HÃ²a: ${cnt['HÃ²a']} (${((cnt['HÃ²a']/total)*100).toFixed(1)}%)\n\n`;
  basicText += `âœ… Player side tháº¯ng: ${playerWin} vÃ¡n (${((playerWin/total)*100).toFixed(1)}%)\n`;
  basicText += `âœ… Banker side tháº¯ng: ${bankerWin} vÃ¡n (${((bankerWin/total)*100).toFixed(1)}%)\n`;
  basicText += `ğŸ¤ HÃ²a: ${tie} vÃ¡n (${((tie/total)*100).toFixed(1)}%)\n\n`;
  basicText += `ğŸ”¥ Streak hiá»‡n táº¡i: ${currentStreak} vÃ¡n liÃªn tiáº¿p ${streakType}\n`;
  basicText += `ğŸ† Longest streak: ${maxStreak} vÃ¡n liÃªn tiáº¿p\n`;

  if (total >= 10) {
    const last10 = hist.slice(-10);
    const cnt10 = {'Long báº£o xanh':0, 'Long báº£o Ä‘á»':0, 'ÄÃ´i xanh':0, 'ÄÃ´i Ä‘á»':0, 'HÃ²a':0};
    last10.forEach(v => cnt10[v]++);
    const player10 = cnt10['Long báº£o xanh'] + cnt10['ÄÃ´i xanh'];
    const banker10 = cnt10['Long báº£o Ä‘á»'] + cnt10['ÄÃ´i Ä‘á»'];
    const tie10 = cnt10['HÃ²a'];
    basicText += `\nğŸ“ˆ Xu hÆ°á»›ng gáº§n Ä‘Ã¢y (Last 10 vÃ¡n):\n`;
    basicText += `â€¢ Long báº£o xanh: ${cnt10['Long báº£o xanh']} (${(cnt10['Long báº£o xanh']/10*100).toFixed(1)}%)\n`;
    basicText += `â€¢ Long báº£o Ä‘á»: ${cnt10['Long báº£o Ä‘á»']} (${(cnt10['Long báº£o Ä‘á»']/10*100).toFixed(1)}%)\n`;
    basicText += `â€¢ ÄÃ´i xanh: ${cnt10['ÄÃ´i xanh']} (${(cnt10['ÄÃ´i xanh']/10*100).toFixed(1)}%)\n`;
    basicText += `â€¢ ÄÃ´i Ä‘á»: ${cnt10['ÄÃ´i Ä‘á»']} (${(cnt10['ÄÃ´i Ä‘á»']/10*100).toFixed(1)}%)\n`;
    basicText += `â€¢ HÃ²a: ${cnt10['HÃ²a']} (${(cnt10['HÃ²a']/10*100).toFixed(1)}%)\n\n`;
    basicText += `âœ… Player side: ${player10} (${(player10/10*100).toFixed(1)}%)\n`;
    basicText += `âœ… Banker side: ${banker10} (${(banker10/10*100).toFixed(1)}%)\n`;
    basicText += `ğŸ¤ HÃ²a: ${tie10} (${(tie10/10*100).toFixed(1)}%)\n`;
  }

  let finalText = basicText;

  if (isVIP) {
    const markov = markovPrediction();
    finalText += "\n\n" + markov;
    document.getElementById('markovText').innerHTML = markov.replace(/\n/g, '<br>');
    document.getElementById('vipMarkov').classList.remove('hidden');
  }

  const apiKey = document.getElementById('key').value.trim();
  if (apiKey) {
    document.getElementById('out').textContent = "ğŸ¤– Äang há»i Gemini 2.5 Flash... chá» vÃ i giÃ¢y";
    try {
      const prompt = `Báº¡n lÃ  chuyÃªn gia phÃ¢n tÃ­ch game Rá»“ng Há»• (Dragon Tiger). HÃ£y phÃ¢n tÃ­ch lá»‹ch sá»­ ${total} vÃ¡n chÆ¡i sau (má»›i nháº¥t á»Ÿ cuá»‘i):\n${hist.join(' â†’ ')}\n\nTÃ¬m xu hÆ°á»›ng, streak, hot/cold, xu hÆ°á»›ng 10 vÃ¡n gáº§n nháº¥t, vÃ  Ä‘Æ°a ra gá»£i Ã½ cá»­a nÃªn Ä‘Ã¡nh tiáº¿p theo kÃ¨m lÃ½ do thuyáº¿t phá»¥c, xÃ¡c suáº¥t Æ°á»›c lÆ°á»£ng. Sá»­ dá»¥ng tiáº¿ng Viá»‡t, thÃªm emoji cho sinh Ä‘á»™ng, ngáº¯n gá»n nhÆ°ng chi tiáº¿t vÃ  háº¥p dáº«n.`;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      });

      if (response.ok) {
        const data = await response.json();
        const aiText = data.candidates[0].content.parts[0].text.trim();
        finalText = aiText + "\n\n---\nğŸ“Š Thá»‘ng kÃª cÆ¡ báº£n:\n" + basicText;
      } else {
        const errorData = await response.json();
        finalText += `\n\nâš ï¸ Lá»—i Gemini: ${errorData.error?.message || 'Key sai hoáº·c rate limit'}. Chá»‰ dÃ¹ng thá»‘ng kÃª + Markov.`;
      }
    } catch (e) {
      finalText += "\n\nâš ï¸ Lá»—i máº¡ng khi gá»i Gemini. Chá»‰ dÃ¹ng thá»‘ng kÃª + Markov.";
    }
  }

  document.getElementById('out').textContent = finalText;
  drawChart(stats);

  if (ttsReady) speak(finalText);
}

function toggleGuide() {
  const g = document.getElementById('guide');
  g.style.display = g.style.display === 'block' ? 'none' : 'block';
}

function unlockVIP() {
  if (document.getElementById('vipKey').value.trim() === 'admin123') {
    isVIP = true;
    localStorage.setItem('isVIP', 'true');
    document.getElementById('vipSection').style.display = 'none';
    document.getElementById('vipMarkov').classList.remove('hidden');
    document.getElementById('voiceControls').classList.remove('hidden');
    alert('ğŸ‰ VIP Ä‘Ã£ má»Ÿ khÃ³a thÃ nh cÃ´ng! Báº¡n giá» cÃ³ Second-order Markov + giá»ng nÃ³i nÃ¢ng cao.');
    loadVoices();
  } else {
    alert('âŒ Key sai rá»“i! Thá»­ láº¡i nhÃ©.');
  }
}

function resetAll() {
  if (hist.length === 0 || confirm("XÃ³a toÃ n bá»™ dá»¯ liá»‡u lá»‹ch sá»­?")) {
    hist = [];
    saveHistory();
    render();
    document.getElementById('out').textContent = "ÄÃ£ reset sáº¡ch sáº½! ğŸ‘Œ Báº¯t Ä‘áº§u láº¡i nÃ o.";
    document.getElementById('chartContainer').style.display = 'none';
    document.getElementById('vipMarkov').classList.add('hidden');
    if (chart) { chart.destroy(); chart = null; }
    stopSpeech();
  }
}

window.onload = () => {
  const savedKey = localStorage.getItem('geminiKey');
  if (savedKey) document.getElementById('key').value = savedKey;

  document.getElementById('key').addEventListener('blur', () => {
    const keyVal = document.getElementById('key').value.trim();
    if (keyVal) localStorage.setItem('geminiKey', keyVal);
    else localStorage.removeItem('geminiKey');
  });

  loadHistory();
  render();
  loadVoices();
  synth.onvoiceschanged = loadVoices;

  if (isVIP) {
    document.getElementById('vipSection').style.display = 'none';
    document.getElementById('vipMarkov').classList.remove('hidden');
    document.getElementById('voiceControls').classList.remove('hidden');
  }

  document.body.addEventListener('touchstart', enableTTS, { once: true });
  document.body.addEventListener('click', enableTTS, { once: true });
};
</script>
</body>
</html>
